<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cape Coral Home Retreat - Guest Portal</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            min-height: 100vh;
        }
        .nav {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,180,216,0.1);
            border-left: 6px solid #00B4D8;
        }
        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(245,158,11,0.1);
            border-left: 6px solid #F77F00;
        }
        .btn {
            background: linear-gradient(135deg, #00B4D8, #0096C7);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            border-bottom: 4px solid #F77F00;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        .btn:hover {
            background: linear-gradient(135deg, #0096C7, #0077B6);
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn.active {
            background: linear-gradient(135deg, #0077B6, #023E8A);
            border-bottom-color: #D97706;
        }
        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            border-bottom-color: #B91C1C;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
        }
        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            border-bottom-color: #047857;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }
        .btn:disabled {
            background: #9CA3AF !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .card {
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            padding: 24px;
            margin: 20px 0;
            border-radius: 12px;
            border-left: 5px solid #00B4D8;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .admin-card {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border-left-color: #F59E0B;
        }
        .emergency-card {
            background: linear-gradient(135deg, #FEF2F2, #FECACA);
            border-left-color: #EF4444;
        }
        .attraction-card {
            background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
            border-left-color: #F77F00;
            transition: all 0.2s ease;
        }
        .attraction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(247,127,0,0.2);
        }
        h1, h2, h3 {
            color: #1F2937;
        }
        .phone-link {
            color: #00B4D8;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .phone-link:hover {
            color: #0096C7;
        }
        .form-group {
            margin: 20px 0;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #374151;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: #00B4D8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,180,216,0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .admin-login {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .alert-success {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            border-left: 4px solid #10B981;
            color: #065F46;
        }
        .alert-error {
            background: linear-gradient(135deg, #FEF2F2, #FECACA);
            border-left: 4px solid #EF4444;
            color: #991B1B;
        }
        .alert-info {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            border-left: 4px solid #3B82F6;
            color: #1E40AF;
        }
        .small-text {
            font-size: 14px;
            color: #6B7280;
            margin-top: 5px;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .welcome-banner {
            background: linear-gradient(135deg, #00B4D8, #0077B6);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-bottom: 6px solid #F77F00;
            text-align: center;
        }
        .welcome-banner h2 {
            color: white;
            margin-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .nav-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 15px 0;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .nav-grid {
                flex-direction: column;
                align-items: center;
            }
        }
        .booking-history {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .booking-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00B4D8;
        }
        .current-booking {
            border-left-color: #10B981 !important;
            background: linear-gradient(135deg, #F0FDF4, #DCFCE7) !important;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .quick-action-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #00B4D8;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .quick-action-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="nav">
        <h1>üèñÔ∏è Cape Coral Home Retreat</h1>
        <p>123 SW 51st Terrace, Cape Coral, Florida</p>
        <div id="guest-nav" class="nav-grid">
            <button class="btn active" onclick="showPage('home', this)">üè† Welcome</button>
            <button class="btn" onclick="showPage('access', this)">üîë Access Info</button>
            <button class="btn" onclick="showPage('attractions', this)">üìç Attractions</button>
            <button class="btn" onclick="showPage('music', this)">üéµ Music</button>
            <button class="btn" onclick="showPage('rules', this)">üìã Rules</button>
            <button class="btn" onclick="showPage('emergency', this)">üìû Emergency</button>
            <button class="btn" id="admin-btn" onclick="showPage('admin-login', this)">‚öôÔ∏è Admin</button>
        </div>
        <div id="admin-nav" class="nav-grid" style="display: none;">
            <button class="btn" onclick="showPage('admin-bookings', this); return false;">üìÖ Bookings</button>
            <button class="btn" onclick="showPage('admin-property', this); return false;">üè† Property</button>
            <button class="btn" onclick="showPage('admin-import', this); return false;">üì§ Import CSV</button>
            <button class="btn" onclick="showPage('admin-history', this); return false;">üìã History</button>
            <button class="btn btn-danger" onclick="logout(); return false;">üö™ Logout</button>
        </div>
    </div>

    <div class="content">
        <!-- Home Page -->
        <div id="home-page">
            <div class="welcome-banner">
                <h2>Welcome to Cape Coral Home Retreat!</h2>
                <p>Your tropical paradise awaits in beautiful Cape Coral, Florida!</p>
            </div>
            
            <div class="stats-grid">
                <div class="card">
                    <h3>üìÖ Current Booking</h3>
                    <p><strong>Guest:</strong> <span id="display-guest-name">No current booking</span></p>
                    <p><strong>Check-in:</strong> <span id="display-checkin">--</span></p>
                    <p><strong>Check-out:</strong> <span id="display-checkout">--</span></p>
                    <p><strong>Guests:</strong> <span id="display-guest-count">--</span></p>
                    <p><strong>Confirmation:</strong> <span id="display-confirmation">--</span></p>
                </div>
                
                <div class="card" style="border-left-color: #F77F00;">
                    <h3>üîë Access Information</h3>
                    <p><strong>Door Code:</strong> <span id="display-door-code">1234</span></p>
                    <p><strong>WiFi:</strong> <span id="display-wifi-name">CapeCoral_Retreat_Guest</span></p>
                    <p><strong>Password:</strong> <span id="display-wifi-password">Tropical2025!</span></p>
                    <p class="small-text">Please keep this information secure</p>
                </div>
            </div>
        </div>

        <!-- Access Page -->
        <div id="access-page" style="display: none;">
            <h2>üîë Access Information</h2>
            <div class="stats-grid">
                <div class="card" style="background: linear-gradient(135deg, #DBEAFE, #BFDBFE); border-left-color: #2563EB;">
                    <h3>Door Access</h3>
                    <p style="font-size: 48px; font-weight: bold; color: #2563EB; margin: 15px 0; text-align: center;"><span id="access-door-code">1234</span></p>
                    <p style="text-align: center;">Enter this code on the front door keypad</p>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, #DCFCE7, #BBF7D0); border-left-color: #16A34A;">
                    <h3>WiFi Network</h3>
                    <p style="font-weight: bold; color: #16A34A; font-size: 18px;"><span id="access-wifi-name">CapeCoral_Retreat_Guest</span></p>
                    <p style="font-weight: bold; color: #16A34A; font-size: 18px;"><span id="access-wifi-password">Tropical2025!</span></p>
                    <p class="small-text">Connect your devices to stay online</p>
                </div>
            </div>
        </div>

        <!-- Attractions Page -->
        <div id="attractions-page" style="display: none;">
            <h2>üìç Local Attractions</h2>
            <div class="stats-grid">
                <div class="attraction-card">
                    <h3>Yacht Club Beach</h3>
                    <p>Beach ‚Ä¢ 2.5 miles (6 min drive) ‚Ä¢ ‚≠ê 4.5</p>
                </div>
                <div class="attraction-card">
                    <h3>Cape Coral Beach at Four Freedoms Park</h3>
                    <p>Beach ‚Ä¢ 3.2 miles (8 min drive) ‚Ä¢ ‚≠ê 4.3</p>
                </div>
                <div class="attraction-card">
                    <h3>The Lobster Lady</h3>
                    <p>Restaurant ‚Ä¢ 4.8 miles (12 min drive) ‚Ä¢ ‚≠ê 5.0</p>
                </div>
                <div class="attraction-card">
                    <h3>Rotary Park Environmental Center</h3>
                    <p>Nature ‚Ä¢ 5.1 miles (12 min drive) ‚Ä¢ ‚≠ê 4.4</p>
                </div>
                <div class="attraction-card">
                    <h3>Sun Splash Family Waterpark</h3>
                    <p>Entertainment ‚Ä¢ 6.3 miles (15 min drive) ‚Ä¢ ‚≠ê 4.1</p>
                </div>
                <div class="attraction-card">
                    <h3>Cape Coral Farmers Market</h3>
                    <p>Shopping ‚Ä¢ 4.2 miles (10 min drive) ‚Ä¢ ‚≠ê 4.2</p>
                </div>
                <div class="attraction-card">
                    <h3>Edison and Ford Winter Estates</h3>
                    <p>Historical ‚Ä¢ 8.7 miles (20 min drive) ‚Ä¢ ‚≠ê 4.6</p>
                </div>
                <div class="attraction-card">
                    <h3>Seed to Table</h3>
                    <p>Restaurant ‚Ä¢ 15.2 miles to Naples (25 min drive) ‚Ä¢ ‚≠ê 5.0</p>
                </div>
            </div>
        </div>

        <!-- Music Page -->
        <div id="music-page" style="display: none;">
            <h2>üéµ Home Audio System</h2>
            
            <div class="card" style="background: linear-gradient(135deg, #1DB954, #1ed760); color: white; border-left-color: #1DB954;">
                <h3 style="color: white;">üéß Connect to Juke Audio System</h3>
                <p style="color: white; opacity: 0.9;">Control the house music from your device!</p>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="connectSpotify()" style="background: #1DB954; border-bottom-color: #17a74a;">
                        üéµ Connect Spotify
                    </button>
                    <button class="btn" onclick="showJukeInstructions()" style="background: #333; border-bottom-color: #1DB954;">
                        üì± Juke Audio App
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>üé∂ Quick Setup Instructions</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Method 1: Spotify Connect (Recommended)</h4>
                    <ol>
                        <li>Open <strong>Spotify</strong> on your phone or tablet</li>
                        <li>Play any song</li>
                        <li>Tap the <strong>"Devices"</strong> icon at the bottom</li>
                        <li>Select <strong>"Cape Coral Retreat Audio"</strong> from the list</li>
                        <li>Music will now play through the house speakers!</li>
                    </ol>
                </div>
                
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Method 2: Juke Audio App</h4>
                    <ol>
                        <li>Download the <strong>"Juke Audio"</strong> app from App Store/Google Play</li>
                        <li>Connect to the house WiFi: <strong id="music-wifi-name">CapeCoral_Retreat_Guest</strong></li>
                        <li>Open Juke Audio app and select <strong>"Cape Coral Home"</strong></li>
                        <li>Log in with your Spotify, Apple Music, or other streaming service</li>
                        <li>Control volume and music from the app!</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Rules Page -->
        <div id="rules-page" style="display: none;">
            <h2>üìã Property Rules & Guidelines</h2>
            <div class="card">
                <p>‚úÖ Check-in: 4:00 PM - 9:00 PM (Please contact us if arriving after 9 PM)</p>
            </div>
            <div class="card">
                <p>‚úÖ Check-out: 11:00 AM (Late check-out available upon request)</p>
            </div>
            <div class="card">
                <p>‚úÖ No smoking anywhere on the property (including lanai and pool area)</p>
            </div>
            <div class="card">
                <p>‚úÖ Maximum occupancy: 6 guests</p>
            </div>
            <div class="card">
                <p>‚úÖ Quiet hours: 10:00 PM - 8:00 AM (Respect our neighbors)</p>
            </div>
            <div class="card">
                <p>‚úÖ Pool hours: 8:00 AM - 10:00 PM</p>
            </div>
            <div class="card">
                <p>‚úÖ No glass containers in pool area</p>
            </div>
            <div class="card">
                <p>‚úÖ Please rinse off before entering pool after beach visits</p>
            </div>
            <div class="card">
                <p>‚úÖ All towels and linens provided - no need to bring your own</p>
            </div>
            <div class="card">
                <p>‚úÖ Parking: Maximum 2 vehicles in driveway</p>
            </div>
            <div class="card">
                <p>‚úÖ No pets allowed (service animals welcome with prior notice)</p>
            </div>
            <div class="card">
                <p>‚úÖ Please dispose of trash in provided bins - pickup is Wednesday</p>
            </div>
        </div>

        <!-- Emergency Page -->
        <div id="emergency-page" style="display: none;">
            <h2>üìû Emergency Contacts</h2>
            <div class="stats-grid">
                <div class="emergency-card">
                    <h3>Property Manager</h3>
                    <p style="font-size: 28px; font-weight: bold; margin: 15px 0;">
                        <a href="tel:+12397229391" class="phone-link">(239) 722-9391</a>
                    </p>
                </div>
                <div class="emergency-card">
                    <h3>Emergency Services</h3>
                    <p style="font-size: 28px; font-weight: bold; margin: 15px 0;">
                        <a href="tel:911" class="phone-link">911</a>
                    </p>
                </div>
                <div class="emergency-card">
                    <h3>Cape Coral Police</h3>
                    <p style="font-size: 28px; font-weight: bold; margin: 15px 0;">
                        <a href="tel:+12395743223" class="phone-link">(239) 574-3223</a>
                    </p>
                </div>
                <div class="emergency-card">
                    <h3>Lee Memorial Hospital</h3>
                    <p style="font-size: 28px; font-weight: bold; margin: 15px 0;">
                        <a href="tel:+12393432000" class="phone-link">(239) 343-2000</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="admin-login-page" style="display: none;">
            <div class="admin-login">
            <!-- Data Recovery Section -->
        <div id="data-recovery" class="admin-card card" style="display: none;">
            <h3>üîÑ Data Recovery</h3>
            <p>If you lost reservation data, try these recovery options:</p>
            <div style="margin: 15px 0;">
                <button class="btn btn-warning" onclick="attemptDataRecovery(); return false;">üîÑ Attempt Data Recovery</button>
                <button class="btn" onclick="showDataBackups(); return false;">üìã Show Available Backups</button>
                <button class="btn btn-success" onclick="addSampleReservations(); return false;">üìÑ Add Sample Reservations</button>
            </div>
            <div id="recovery-results" style="margin-top: 15px;"></div>
        </div>
                    <h2>üîê Admin Access</h2>
                    <p>Enter admin password to manage property settings</p>
                    <div class="form-group">
                        <input type="password" id="admin-password" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
                    </div>
                    <button class="btn btn-success" onclick="login()">Login</button>
                    
                    <div id="password-attempts" style="margin-top: 15px; display: none;">
                        <div class="alert alert-error">
                            <span id="attempt-message">No No No that was the wrong password! Try again.</span><br>
                            <small>Attempts: <span id="attempt-count">0</span>/5</small>
                        </div>
                    </div>
                    
                    <div id="locked-out" style="margin-top: 15px; display: none;">
                        <div class="alert alert-error">
                            <strong>üö´ Access Locked!</strong><br>
                            Too many failed attempts. Please wait 30 seconds before trying again.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Bookings -->
        <div id="admin-bookings-page" style="display: none;">
            <h2>üìÖ Booking Management</h2>
            
            <!-- Quick Actions -->
            <div class="admin-card card">
                <h3>‚ö° Quick Actions</h3>
                <div class="quick-actions">
                    <div class="quick-action-card" onclick="quickCheckIn(); return false;">
                        <h4>üè† Check-In Guest</h4>
                        <p>Mark arrival and activate booking</p>
                    </div>
                    <div class="quick-action-card" onclick="quickCheckOut(); return false;">
                        <h4>üß≥ Check-Out Guest</h4>
                        <p>Complete stay and archive booking</p>
                    </div>
                    <div class="quick-action-card" onclick="generateDoorCode(); return false;">
                        <h4>üîë New Door Code</h4>
                        <p>Generate secure access code</p>
                    </div>
                    <div class="quick-action-card" onclick="clearCurrentBooking(); return false;">
                        <h4>üóëÔ∏è Clear Booking</h4>
                        <p>Remove current guest info</p>
                    </div>
                </div>
            </div>
            
            <div class="admin-card card">
                <h3>üìù Add/Edit Current Booking</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Guest Name *</label>
                        <input type="text" id="admin-guest-name" placeholder="John & Sarah Smith">
                    </div>
                    <div class="form-group">
                        <label>Guest Count *</label>
                        <input type="number" id="admin-guest-count" min="1" max="6" placeholder="4">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Check-in Date *</label>
                        <input type="date" id="admin-checkin" onchange="validateDates()">
                    </div>
                    <div class="form-group">
                        <label>Check-out Date *</label>
                        <input type="date" id="admin-checkout" onchange="validateDates()">
                        <div id="date-error" class="alert-error" style="display: none; margin-top: 8px; padding: 10px; border-radius: 6px;">
                            Check-out must be at least 1 day after check-in
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Confirmation Code</label>
                        <input type="text" id="admin-confirmation" placeholder="ABC123">
                    </div>
                    <div class="form-group">
                        <label>Special Notes</label>
                        <input type="text" id="admin-notes" placeholder="Early check-in, anniversary">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveBooking(); return false;">üíæ Save Booking</button>
                <button class="btn" onclick="loadSampleData(); return false;">üìÑ Load Sample Data</button>
                
                <div id="save-success" style="display: none;" class="alert alert-success">
                    ‚úÖ Booking saved successfully! Guest portal updated automatically.
                </div>
            </div>

            <div class="admin-card card">
                <h3>üì∂ WiFi & Access Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Network Name</label>
                        <input type="text" id="admin-wifi-name" placeholder="CapeCoral_Retreat_Guest">
                    </div>
                    <div class="form-group">
                        <label>WiFi Password</label>
                        <input type="text" id="admin-wifi-password" placeholder="Tropical2025!">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Door Code</label>
                        <input type="text" id="admin-door-code" placeholder="1234" maxlength="6">
                        <div class="small-text">4-6 digits recommended</div>
                    </div>
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button class="btn" onclick="generateDoorCode()" style="margin: 0;">üé≤ Generate Code</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="savePropertySettings(); return false;">üíæ Save Settings</button>
            </div>
        </div>

        <!-- Admin Property -->
        <div id="admin-property-page" style="display: none;">
            <h2>üè† Property Management</h2>
            
            <div class="admin-card card">
                <h3>üìä Current Status</h3>
                <div class="stats-grid">
                    <div class="card">
                        <h4>üè† Occupancy Status</h4>
                        <p id="occupancy-status">Available</p>
                        <p class="small-text" id="occupancy-details">No current guests</p>
                    </div>
                    <div class="card">
                        <h4>üîë Access Active</h4>
                        <p id="access-status">Secured</p>
                        <p class="small-text">Door code: <span id="current-door-code">****</span></p>
                    </div>
                </div>
            </div>

            <div class="admin-card card">
                <h3>üßπ Cleaning & Maintenance</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cleaning Company</label>
                        <input type="text" id="cleaning-company" placeholder="Cape Coral Cleaning Services">
                    </div>
                    <div class="form-group">
                        <label>Contact Number</label>
                        <input type="tel" id="cleaning-phone" placeholder="(239) 555-0123">
                    </div>
                </div>
                <div class="form-group">
                    <label>Last Cleaned</label>
                    <input type="date" id="last-cleaned">
                </div>
                <div class="form-group">
                    <label>Next Scheduled Cleaning</label>
                    <input type="date" id="next-cleaning">
                </div>
                <button class="btn btn-success" onclick="saveMaintenanceInfo()">üíæ Save Maintenance Info</button>
            </div>

            <div class="admin-card card">
                <h3>üìû Emergency Contacts</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Property Manager</label>
                        <input type="tel" id="manager-phone" placeholder="(239) 574-1234">
                    </div>
                    <div class="form-group">
                        <label>Backup Contact</label>
                        <input type="tel" id="backup-phone" placeholder="(239) 555-0123">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveEmergencyContacts()">üíæ Save Contacts</button>
            </div>
        </div>

        <!-- Admin Import CSV -->
        <div id="admin-import-page" style="display: none;">
            <h2>üì§ Import Airbnb Reservations</h2>
            
            <div class="admin-card card">
                <h3>üìã How to Export from Airbnb</h3>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Step 1: Export from Airbnb</h4>
                    <ol>
                        <li>Go to your <strong>Airbnb Host Dashboard</strong></li>
                        <li>Click <strong>"Progress"</strong> in the left menu</li>
                        <li>Scroll down to <strong>"Data Export"</strong></li>
                        <li>Select <strong>"Reservations"</strong> and your date range</li>
                        <li>Download the CSV file</li>
                    </ol>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Step 2: Upload Here</h4>
                    <p>Upload your Airbnb CSV file and we'll automatically import all reservations!</p>
                </div>
            </div>

            <div class="admin-card card">
                <h3>üìÇ Upload Airbnb CSV File</h3>
                <div class="form-group">
                    <label>Select CSV File</label>
                    <input type="file" id="csv-file-input" accept=".csv" style="padding: 10px; border: 2px dashed #00B4D8; background: #f8f9fa; border-radius: 8px;">
                    <div class="small-text">Accepts CSV files exported from Airbnb</div>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="processCsvFile(); return false;">üì§ Import Reservations</button>
                    <button class="btn" onclick="downloadSampleCsv(); return false;">üìÑ Download Sample CSV</button>
                </div>
                
                <div id="import-progress" style="display: none;" class="alert alert-info">
                    üîÑ Processing CSV file...
                </div>
                
                <div id="import-results" style="display: none;"></div>
            </div>

            <div class="admin-card card">
                <h3>üìä Manual CSV Format</h3>
                <p>If you prefer to create your own CSV, use this format:</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; margin: 15px 0;">
                    Guest Name,Check-in,Check-out,Guests,Confirmation,Phone,Email<br>
                    "John & Sarah Smith","2025-07-18","2025-07-21",4,"ABC123","555-0123","john@email.com"<br>
                    "Mike Johnson","2025-08-01","2025-08-05",2,"DEF456","555-0124","mike@email.com"
                </div>
                <div class="small-text">
                    <strong>Required fields:</strong> Guest Name, Check-in, Check-out, Guests<br>
                    <strong>Optional fields:</strong> Confirmation, Phone, Email, Notes
                </div>
            </div>

            <div class="admin-card card">
                <h3>üîß Import Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="overwrite-existing" checked> 
                            Overwrite existing bookings with same dates
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto-generate-codes" checked> 
                            Auto-generate door codes for new bookings
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Default WiFi for imported bookings</label>
                    <input type="text" id="default-wifi" placeholder="CapeCoral_Retreat_Guest" value="">
                </div>
            </div>
        </div>

        <!-- Admin History -->
        <div id="admin-history-page" style="display: none;">
            <h2>üìã Booking History</h2>
            
            <div class="admin-card card">
                <h3>üìÖ Recent Bookings</h3>
                <div id="booking-history" class="booking-history">
                    <!-- Booking history will be populated here -->
                </div>
                <button class="btn btn-danger" onclick="clearAllHistory()">üóëÔ∏è Clear All History</button>
            </div>
        </div>
    </div>

    <script>
        // Global data
        let isLoggedIn = false;
        let currentBooking = null;
        let allReservations = []; // Store all reservations
        let editingReservationId = null; // Track which reservation is being edited
        let passwordAttempts = 0; // Track password attempts
        let propertySettings = {
            wifiName: 'CapeCoral_Retreat_Guest',
            wifiPassword: 'Tropical2025!',
            doorCode: '1234'
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing application');
            
            // Try to recover data from multiple sources
            recoverLostData();
            loadData();
            updateDisplay();
        });

        // Data recovery function
        function recoverLostData() {
            console.log('Attempting data recovery...');
            
            try {
                // Check for backup data in different localStorage keys
                const backupSources = [
                    'currentBooking_backup',
                    'allReservations_backup', 
                    'bookingHistory',
                    'inventoryItems', // In case data got mixed up
                    'systemUsers'
                ];
                
                let recoveredData = false;
                
                backupSources.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        console.log(`Found data in ${key}:`, data.substring(0, 100));
                    }
                });
                
                // Try to recover from browser's session storage as backup
                const sessionBooking = sessionStorage.getItem('currentBooking');
                const sessionReservations = sessionStorage.getItem('allReservations');
                
                if (sessionBooking && !localStorage.getItem('currentBooking')) {
                    console.log('Recovering currentBooking from session storage');
                    localStorage.setItem('currentBooking', sessionBooking);
                    recoveredData = true;
                }
                
                if (sessionReservations && !localStorage.getItem('allReservations')) {
                    console.log('Recovering allReservations from session storage');
                    localStorage.setItem('allReservations', sessionReservations);
                    recoveredData = true;
                }
                
                if (recoveredData) {
                    console.log('Some data recovered successfully');
                    alert('üîÑ Some reservation data was recovered from backup!');
                }
                
            } catch (error) {
                console.error('Error during data recovery:', error);
            }
        }

        // Page navigation
        function showPage(pageId, buttonElement) {
            console.log('showPage called with:', pageId);
            
            try {
                // Hide all pages
                const pages = document.querySelectorAll('[id$="-page"]');
                pages.forEach(page => {
                    page.style.display = 'none';
                    console.log('Hiding page:', page.id);
                });
                
                // Show selected page
                const targetPage = document.getElementById(pageId + '-page');
                if (targetPage) {
                    targetPage.style.display = 'block';
                    console.log('Showing page:', pageId + '-page');
                } else {
                    console.error('Page not found:', pageId + '-page');
                    alert('‚ùå Page not found: ' + pageId);
                    return false;
                }
                
                // Update navigation buttons
                const navButtons = document.querySelectorAll('.nav button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                
                if (buttonElement) {
                    buttonElement.classList.add('active');
                    console.log('Button activated:', buttonElement.textContent);
                }
                
                // Load page-specific data
                if (pageId === 'admin-history') {
                    console.log('Loading booking history');
                    loadBookingHistory();
                } else if (pageId === 'admin-property') {
                    console.log('Loading property status');
                    loadPropertyStatus();
                } else if (pageId === 'admin-import') {
                    console.log('Loading import settings');
                    loadImportSettings();
                } else if (pageId === 'admin-bookings') {
                    console.log('Loading admin booking data');
                    loadAdminData();
                    updateCurrentBookingDisplay();
                    loadAllReservations();
                }
                
                console.log('Page navigation completed successfully');
                return false;
                
            } catch (error) {
                console.error('Error in showPage:', error);
                alert('‚ùå Error navigating to page: ' + error.message);
                return false;
            }
        }

        // Load data from localStorage
        function loadData() {
            try {
                // Load current booking
                const savedBooking = localStorage.getItem('currentBooking');
                if (savedBooking) {
                    currentBooking = JSON.parse(savedBooking);
                } else {
                    // Set default demo booking for GitHub/new visitors
                    currentBooking = {
                        id: 'demo-booking',
                        guestName: 'John & Sarah Smith',
                        guestCount: 4,
                        checkin: '2025-07-18',
                        checkout: '2025-07-21',
                        confirmation: 'ABC123',
                        notes: 'Anniversary celebration',
                        createdAt: new Date().toISOString(),
                        status: 'active'
                    };
                }

                // Load all reservations
                const savedReservations = localStorage.getItem('allReservations');
                if (savedReservations) {
                    allReservations = JSON.parse(savedReservations);
                } else {
                    // Set default demo reservations for GitHub/new visitors
                    allReservations = [
                        {
                            id: 'demo-1',
                            guestName: 'John & Sarah Smith',
                            guestCount: 4,
                            checkin: '2025-07-18',
                            checkout: '2025-07-21',
                            confirmation: 'ABC123',
                            notes: 'Anniversary celebration',
                            createdAt: new Date().toISOString(),
                            status: 'active'
                        },
                        {
                            id: 'demo-2',
                            guestName: 'Mike Johnson',
                            guestCount: 2,
                            checkin: '2025-08-01',
                            checkout: '2025-08-05',
                            confirmation: 'DEF456',
                            notes: 'Business trip',
                            createdAt: new Date().toISOString(),
                            status: 'active'
                        }
                    ];
                }

                // Load property settings
                const savedSettings = localStorage.getItem('propertySettings');
                if (savedSettings) {
                    propertySettings = JSON.parse(savedSettings);
                }

                console.log('Data loaded successfully');
                console.log('Current booking:', currentBooking);
                console.log('All reservations:', allReservations.length);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Save data to localStorage with backup
        function saveData() {
            try {
                // Create backups before saving
                const currentData = {
                    currentBooking: currentBooking,
                    allReservations: allReservations,
                    propertySettings: propertySettings,
                    timestamp: new Date().toISOString()
                };
                
                // Save main data
                localStorage.setItem('currentBooking', JSON.stringify(currentBooking));
                localStorage.setItem('allReservations', JSON.stringify(allReservations));
                localStorage.setItem('propertySettings', JSON.stringify(propertySettings));
                
                // Save backup copies
                localStorage.setItem('currentBooking_backup', JSON.stringify(currentBooking));
                localStorage.setItem('allReservations_backup', JSON.stringify(allReservations));
                localStorage.setItem('dataBackup', JSON.stringify(currentData));
                
                // Also save to session storage as additional backup
                sessionStorage.setItem('currentBooking', JSON.stringify(currentBooking));
                sessionStorage.setItem('allReservations', JSON.stringify(allReservations));
                
                console.log('Data saved successfully with backups');
                console.log('Current booking:', currentBooking);
                console.log('All reservations count:', allReservations.length);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Update all display elements
        function updateDisplay() {
            if (currentBooking) {
                // Update home page
                document.getElementById('display-guest-name').textContent = currentBooking.guestName || 'No current booking';
                document.getElementById('display-checkin').textContent = currentBooking.checkin || '--';
                document.getElementById('display-checkout').textContent = currentBooking.checkout || '--';
                document.getElementById('display-guest-count').textContent = currentBooking.guestCount || '--';
                document.getElementById('display-confirmation').textContent = currentBooking.confirmation || '--';
            } else {
                // Clear display when no booking
                document.getElementById('display-guest-name').textContent = 'No current booking';
                document.getElementById('display-checkin').textContent = '--';
                document.getElementById('display-checkout').textContent = '--';
                document.getElementById('display-guest-count').textContent = '--';
                document.getElementById('display-confirmation').textContent = '--';
            }

            // Update access info
            document.getElementById('display-door-code').textContent = propertySettings.doorCode;
            document.getElementById('display-wifi-name').textContent = propertySettings.wifiName;
            document.getElementById('display-wifi-password').textContent = propertySettings.wifiPassword;
            
            // Update access page
            document.getElementById('access-door-code').textContent = propertySettings.doorCode;
            document.getElementById('access-wifi-name').textContent = propertySettings.wifiName;
            document.getElementById('access-wifi-password').textContent = propertySettings.wifiPassword;
            
            // Update music page
            document.getElementById('music-wifi-name').textContent = propertySettings.wifiName;
        }

        // Admin login
        function login() {
            const password = document.getElementById('admin-password').value;
            const attemptDiv = document.getElementById('password-attempts');
            const lockedDiv = document.getElementById('locked-out');
            const attemptMessage = document.getElementById('attempt-message');
            const attemptCount = document.getElementById('attempt-count');
            const loginButton = document.querySelector('#admin-login-page .btn-success');
            const passwordField = document.getElementById('admin-password');
            
            // Check if locked out
            const lockoutTime = localStorage.getItem('adminLockoutTime');
            if (lockoutTime && Date.now() < parseInt(lockoutTime)) {
                lockedDiv.style.display = 'block';
                attemptDiv.style.display = 'none';
                loginButton.disabled = true;
                passwordField.disabled = true;
                return;
            } else if (lockoutTime && Date.now() >= parseInt(lockoutTime)) {
                // Unlock after timeout
                localStorage.removeItem('adminLockoutTime');
                passwordAttempts = 0;
                loginButton.disabled = false;
                passwordField.disabled = false;
                lockedDiv.style.display = 'none';
                attemptDiv.style.display = 'none';
            }
            
            if (password === 'admin1162') {
                // Successful login - reset attempts
                passwordAttempts = 0;
                localStorage.removeItem('adminLockoutTime');
                attemptDiv.style.display = 'none';
                lockedDiv.style.display = 'none';
                
                isLoggedIn = true;
                document.getElementById('guest-nav').style.display = 'none';
                document.getElementById('admin-nav').style.display = 'flex';
                showPage('admin-bookings');
                loadAdminData();
                
                // Show success message
                const loginPage = document.getElementById('admin-login-page');
                loginPage.innerHTML = '<div class="alert alert-success">‚úÖ Login successful! Redirecting to admin panel...</div>';
                setTimeout(() => {
                    showPage('admin-bookings');
                }, 1000);
            } else {
                // Failed login
                passwordAttempts++;
                
                const funnyMessages = [
                    "No No No that was the wrong password! Try again.",
                    "Nope! No No No! Wrong password. Give it another shot!",
                    "No No No! Still wrong! Don't give up, try again!",
                    "No No No! Getting warmer... just kidding, still wrong! One more try!",
                    "No No No! Last chance before lockout! Think carefully..."
                ];
                
                if (passwordAttempts >= 5) {
                    // Lock out for 30 seconds
                    const lockoutTime = Date.now() + (30 * 1000); // 30 seconds
                    localStorage.setItem('adminLockoutTime', lockoutTime.toString());
                    
                    attemptDiv.style.display = 'none';
                    lockedDiv.style.display = 'block';
                    loginButton.disabled = true;
                    passwordField.disabled = true;
                    
                    // Auto-unlock after 30 seconds
                    setTimeout(() => {
                        passwordAttempts = 0;
                        localStorage.removeItem('adminLockoutTime');
                        loginButton.disabled = false;
                        passwordField.disabled = false;
                        lockedDiv.style.display = 'none';
                        attemptDiv.style.display = 'none';
                        passwordField.value = '';
                        alert('üîì Admin access unlocked! You can try again now.');
                    }, 30000);
                    
                } else {
                    // Show funny message
                    attemptMessage.textContent = funnyMessages[passwordAttempts - 1] || funnyMessages[0];
                    attemptCount.textContent = passwordAttempts;
                    attemptDiv.style.display = 'block';
                    lockedDiv.style.display = 'none';
                    
                    // Clear password field
                    passwordField.value = '';
                    passwordField.focus();
                    
                    // Add a little shake animation
                    passwordField.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        passwordField.style.animation = '';
                    }, 500);
                }
            }
        }

        // Admin logout
        function logout() {
            console.log('Logout function called');
            
            if (confirm('Are you sure you want to logout?')) {
                console.log('User confirmed logout');
                
                try {
                    isLoggedIn = false;
                    
                    // Force hide all admin pages immediately
                    const adminPageIds = ['admin-bookings-page', 'admin-property-page', 'admin-import-page', 'admin-history-page'];
                    adminPageIds.forEach(pageId => {
                        const page = document.getElementById(pageId);
                        if (page) {
                            page.style.display = 'none';
                            console.log(`Hidden page: ${pageId}`);
                        }
                    });
                    
                    // Hide any open forms or sections
                    const formElements = ['reservation-form', 'data-recovery'];
                    formElements.forEach(elemId => {
                        const elem = document.getElementById(elemId);
                        if (elem) elem.style.display = 'none';
                    });
                    
                    // Reset navigation immediately
                    const guestNav = document.getElementById('guest-nav');
                    const adminNav = document.getElementById('admin-nav');
                    
                    if (guestNav) {
                        guestNav.style.display = 'flex';
                        console.log('Guest nav shown');
                    } else {
                        console.error('Guest nav not found');
                    }
                    
                    if (adminNav) {
                        adminNav.style.display = 'none';
                        console.log('Admin nav hidden');
                    } else {
                        console.error('Admin nav not found');
                    }
                    
                    // Reset login form
                    const loginPage = document.getElementById('admin-login-page');
                    if (loginPage) {
                        loginPage.innerHTML = `
                            <div class="admin-login">
                                <div class="admin-card card">
                                    <h2>üîê Admin Access</h2>
                                    <p>Enter admin password to manage property settings</p>
                                    <div class="form-group">
                                        <input type="password" id="admin-password" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
                                    </div>
                                    <button class="btn btn-success" onclick="login()">Login</button>
                                    
                                    <div id="password-attempts" style="margin-top: 15px; display: none;">
                                        <div class="alert alert-error">
                                            <span id="attempt-message">No No No that was the wrong password! Try again.</span><br>
                                            <small>Attempts: <span id="attempt-count">0</span>/5</small>
                                        </div>
                                    </div>
                                    
                                    <div id="locked-out" style="margin-top: 15px; display: none;">
                                        <div class="alert alert-error">
                                            <strong>üö´ Access Locked!</strong><br>
                                            Too many failed attempts. Please wait 30 seconds before trying again.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        console.log('Login form reset');
                    }
                    
                    // Reset password attempts
                    passwordAttempts = 0;
                    
                    // Show home page
                    const homePage = document.getElementById('home-page');
                    if (homePage) {
                        homePage.style.display = 'block';
                        console.log('Home page shown');
                    } else {
                        console.error('Home page not found');
                    }
                    
                    // Reset all navigation buttons
                    const allNavButtons = document.querySelectorAll('.nav button');
                    allNavButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Activate home button
                    const homeButton = document.querySelector('#guest-nav button[onclick*="home"]');
                    if (homeButton) {
                        homeButton.classList.add('active');
                        console.log('Home button activated');
                    } else {
                        console.error('Home button not found');
                    }
                    
                    console.log('Logout completed successfully');
                    
                    // Small delay to ensure all changes are applied
                    setTimeout(() => {
                        // Force refresh the display
                        updateDisplay();
                        console.log('Display refreshed after logout');
                    }, 100);
                    
                } catch (error) {
                    console.error('Error during logout:', error);
                    alert('‚ùå Error during logout: ' + error.message);
                    
                    // Force reload page as fallback
                    if (confirm('Logout encountered an error. Refresh the page?')) {
                        location.reload();
                    }
                }
            } else {
                console.log('User cancelled logout');
            }
        }

        // Load admin form data
        function loadAdminData() {
            console.log('loadAdminData called');
            console.log('Current booking:', currentBooking);
            console.log('All reservations:', allReservations.length);
            
            try {
                // Load property settings first
                console.log('Loading property settings');
                const propertyFields = [
                    { id: 'admin-wifi-name', value: propertySettings.wifiName },
                    { id: 'admin-wifi-password', value: propertySettings.wifiPassword },
                    { id: 'admin-door-code', value: propertySettings.doorCode }
                ];
                
                propertyFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element) {
                        element.value = field.value;
                        console.log(`Set ${field.id} to:`, field.value);
                    } else {
                        console.warn(`Property field not found: ${field.id}`);
                    }
                });
                
                console.log('Admin data loaded successfully');
                
                // Update displays
                updateCurrentBookingDisplay();
                loadAllReservations();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Save booking
        function saveBooking() {
            const guestName = document.getElementById('admin-guest-name').value.trim();
            const guestCount = document.getElementById('admin-guest-count').value;
            const checkin = document.getElementById('admin-checkin').value;
            const checkout = document.getElementById('admin-checkout').value;
            const confirmation = document.getElementById('admin-confirmation').value.trim();
            const notes = document.getElementById('admin-notes').value.trim();

            if (!guestName || !guestCount || !checkin || !checkout) {
                alert('‚ùå Please fill in all required fields (Guest Name, Guest Count, Check-in, Check-out)');
                return;
            }

            if (!validateDates()) {
                return;
            }

            // Save current booking
            currentBooking = {
                guestName,
                guestCount,
                checkin,
                checkout,
                confirmation,
                notes,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            // Save to history
            addToHistory(currentBooking);

            saveData();
            updateDisplay();

            // Show success message
            const successDiv = document.getElementById('save-success');
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Save property settings
        function savePropertySettings() {
            propertySettings.wifiName = document.getElementById('admin-wifi-name').value.trim() || 'CapeCoral_Retreat_Guest';
            propertySettings.wifiPassword = document.getElementById('admin-wifi-password').value.trim() || 'Tropical2025!';
            propertySettings.doorCode = document.getElementById('admin-door-code').value.trim() || '1234';

            saveData();
            updateDisplay();
            alert('‚úÖ Property settings saved successfully!');
        }

        // Validate dates
        function validateDates() {
            const checkin = document.getElementById('admin-checkin').value;
            const checkout = document.getElementById('admin-checkout').value;
            const errorDiv = document.getElementById('date-error');

            if (checkin && checkout) {
                const checkinDate = new Date(checkin);
                const checkoutDate = new Date(checkout);

                if (checkoutDate <= checkinDate) {
                    errorDiv.style.display = 'block';
                    return false;
                }
            }

            errorDiv.style.display = 'none';
            return true;
        }

        // Data Recovery Functions
        function showDataRecovery() {
            const recoveryDiv = document.getElementById('data-recovery');
            if (recoveryDiv) {
                recoveryDiv.style.display = 'block';
                recoveryDiv.scrollIntoView({ behavior: 'smooth' });
            }
            return false;
        }

        function attemptDataRecovery() {
            console.log('Attempting comprehensive data recovery...');
            
            const resultsDiv = document.getElementById('recovery-results');
            let recoveredCount = 0;
            let recoveryLog = [];
            
            try {
                // Check all possible localStorage keys for data
                const allKeys = Object.keys(localStorage);
                recoveryLog.push('Scanning localStorage keys: ' + allKeys.join(', '));
                
                // Look for booking data in various formats
                allKeys.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        if (data && data.includes('guestName') || data.includes('checkin') || data.includes('checkout')) {
                            recoveryLog.push(`Found potential booking data in key: ${key}`);
                            
                            const parsed = JSON.parse(data);
                            
                            // If it's an array of reservations
                            if (Array.isArray(parsed)) {
                                parsed.forEach(item => {
                                    if (item.guestName && item.checkin && item.checkout) {
                                        const exists = allReservations.find(r => r.id === item.id);
                                        if (!exists) {
                                            allReservations.push(item);
                                            recoveredCount++;
                                        }
                                    }
                                });
                            }
                            // If it's a single reservation
                            else if (parsed.guestName && parsed.checkin && parsed.checkout) {
                                const exists = allReservations.find(r => r.id === parsed.id);
                                if (!exists) {
                                    if (!parsed.id) parsed.id = Date.now().toString() + Math.random();
                                    allReservations.push(parsed);
                                    recoveredCount++;
                                }
                            }
                        }
                    } catch (e) {
                        // Skip invalid JSON
                    }
                });
                
                // Save recovered data
                if (recoveredCount > 0) {
                    saveData();
                    loadAllReservations();
                    updateCurrentBookingDisplay();
                }
                
                recoveryLog.push(`Recovery complete. Found ${recoveredCount} reservations.`);
                
                resultsDiv.innerHTML = `
                    <div class="alert ${recoveredCount > 0 ? 'alert-success' : 'alert-info'}">
                        <h4>üîç Recovery Results</h4>
                        <p><strong>Recovered ${recoveredCount} reservations</strong></p>
                        <details style="margin-top: 10px;">
                            <summary>Recovery Log</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; margin-top: 10px;">${recoveryLog.join('\n')}</pre>
                        </details>
                    </div>
                `;
                
                if (recoveredCount > 0) {
                    alert(`‚úÖ Recovered ${recoveredCount} reservations successfully!`);
                } else {
                    alert('‚ÑπÔ∏è No additional reservation data found to recover.');
                }
                
            } catch (error) {
                console.error('Error during recovery:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Recovery Error</h4>
                        <p>Error during recovery: ${error.message}</p>
                    </div>
                `;
            }
            
            return false;
        }

        function showDataBackups() {
            const resultsDiv = document.getElementById('recovery-results');
            
            try {
                const allKeys = Object.keys(localStorage);
                const backupKeys = allKeys.filter(key => 
                    key.includes('backup') || 
                    key.includes('history') || 
                    key.includes('Booking') || 
                    key.includes('reservations')
                );
                
                let backupInfo = backupKeys.map(key => {
                    const data = localStorage.getItem(key);
                    const size = data ? data.length : 0;
                    let preview = '';
                    
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            preview = `Array with ${parsed.length} items`;
                        } else if (parsed.guestName) {
                            preview = `Guest: ${parsed.guestName}`;
                        } else {
                            preview = 'Object data';
                        }
                    } catch (e) {
                        preview = 'Raw data';
                    }
                    
                    return `<li><strong>${key}:</strong> ${size} chars - ${preview}</li>`;
                }).join('');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h4>üíæ Available Backup Data</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${backupInfo || '<li>No backup data found</li>'}
                        </ul>
                        <button class="btn" onclick="attemptDataRecovery(); return false;">üîÑ Try to Recover From These</button>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Error</h4>
                        <p>Error checking backups: ${error.message}</p>
                    </div>
                `;
            }
            
            return false;
        }

        function addSampleReservations() {
            const sampleReservations = [
                {
                    id: Date.now().toString(),
                    guestName: 'John & Sarah Smith',
                    guestCount: 4,
                    checkin: '2025-07-18',
                    checkout: '2025-07-21',
                    confirmation: 'ABC123',
                    notes: 'Anniversary celebration',
                    createdAt: new Date().toISOString(),
                    status: 'active'
                },
                {
                    id: (Date.now() + 1).toString(),
                    guestName: 'Mike Johnson',
                    guestCount: 2,
                    checkin: '2025-08-01',
                    checkout: '2025-08-05',
                    confirmation: 'DEF456',
                    notes: 'Business trip',
                    createdAt: new Date().toISOString(),
                    status: 'active'
                }
            ];
            
            sampleReservations.forEach(reservation => {
                allReservations.push(reservation);
            });
            
            saveData();
            loadAllReservations();
            updateCurrentBookingDisplay();
            
            const resultsDiv = document.getElementById('recovery-results');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h4>‚úÖ Sample Data Added</h4>
                    <p>Added ${sampleReservations.length} sample reservations to help you get started again.</p>
                </div>
            `;
            
            alert(`‚úÖ Added ${sampleReservations.length} sample reservations to your list!`);
            return false;
        }

        // Quick actions
        function quickCheckIn() {
            console.log('quickCheckIn called');
            
            if (!currentBooking) {
                alert('‚ùå No current booking to check in');
                return false;
            }
            
            try {
                currentBooking.status = 'checked-in';
                currentBooking.actualCheckin = new Date().toISOString();
                saveData();
                updateDisplay();
                alert('‚úÖ Guest checked in successfully!');
                loadPropertyStatus();
                console.log('Check-in completed');
            } catch (error) {
                console.error('Error during check-in:', error);
                alert('‚ùå Error during check-in: ' + error.message);
            }
            
            return false;
        }

        // New Reservation Management Functions
        function updateCurrentBookingDisplay() {
            const noCurrent = document.getElementById('no-current-booking');
            const currentInfo = document.getElementById('current-booking-info');
            
            if (currentBooking) {
                noCurrent.style.display = 'none';
                currentInfo.style.display = 'block';
                
                document.getElementById('current-guest-name').textContent = currentBooking.guestName;
                document.getElementById('current-dates').textContent = `${currentBooking.checkin} to ${currentBooking.checkout}`;
                document.getElementById('current-guest-count').textContent = currentBooking.guestCount;
                document.getElementById('current-confirmation').textContent = currentBooking.confirmation || '--';
            } else {
                noCurrent.style.display = 'block';
                currentInfo.style.display = 'none';
            }
        }

        function loadAllReservations() {
            const container = document.getElementById('reservations-list');
            
            if (allReservations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No reservations found. Add your first reservation above!</p>';
                return;
            }

            // Sort reservations by check-in date
            const sortedReservations = [...allReservations].sort((a, b) => new Date(a.checkin) - new Date(b.checkin));
            
            container.innerHTML = sortedReservations.map(reservation => {
                const isActive = currentBooking && currentBooking.id === reservation.id;
                const isPast = new Date(reservation.checkout) < new Date();
                const isUpcoming = new Date(reservation.checkin) > new Date();
                
                let statusClass = 'booking-item';
                let statusText = 'Active';
                let statusColor = '#10b981';
                
                if (isActive) {
                    statusClass += ' current-booking';
                    statusText = 'Current Active';
                    statusColor = '#059669';
                } else if (isPast) {
                    statusText = 'Completed';
                    statusColor = '#6b7280';
                } else if (isUpcoming) {
                    statusText = 'Upcoming';
                    statusColor = '#3b82f6';
                }
                
                return `
                    <div class="${statusClass}" style="margin: 10px 0;">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4>${reservation.guestName}</h4>
                                <p><strong>Dates:</strong> ${reservation.checkin} to ${reservation.checkout}</p>
                                <p><strong>Guests:</strong> ${reservation.guestCount} | <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span></p>
                                ${reservation.confirmation ? `<p><strong>Confirmation:</strong> ${reservation.confirmation}</p>` : ''}
                                ${reservation.notes ? `<p><strong>Notes:</strong> ${reservation.notes}</p>` : ''}
                                <p class="small-text">Added: ${new Date(reservation.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div style="margin-left: 20px; display: flex; flex-direction: column; gap: 5px;">
                                ${!isActive ? `<button class="btn" onclick="setReservationAsCurrent('${reservation.id}'); return false;" style="font-size: 12px; padding: 4px 8px;">üè† Set Current</button>` : ''}
                                <button class="btn" onclick="editReservation('${reservation.id}'); return false;" style="font-size: 12px; padding: 4px 8px;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteReservation('${reservation.id}'); return false;" style="font-size: 12px; padding: 4px 8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddReservationForm() {
            console.log('showAddReservationForm called');
            
            try {
                editingReservationId = null;
                
                const formTitle = document.getElementById('form-title');
                const setCurrentBtn = document.getElementById('set-current-btn');
                const reservationForm = document.getElementById('reservation-form');
                
                if (formTitle) formTitle.textContent = 'üìù Add New Reservation';
                if (setCurrentBtn) setCurrentBtn.style.display = 'none';
                
                // Clear form
                const formFields = ['form-guest-name', 'form-guest-count', 'form-checkin', 'form-checkout', 'form-confirmation', 'form-notes'];
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = '';
                        console.log(`Cleared field: ${fieldId}`);
                    } else {
                        console.warn(`Form field not found: ${fieldId}`);
                    }
                });
                
                if (reservationForm) {
                    reservationForm.style.display = 'block';
                    reservationForm.scrollIntoView({ behavior: 'smooth' });
                    console.log('Reservation form shown');
                } else {
                    console.error('Reservation form not found');
                }
                
            } catch (error) {
                console.error('Error showing add reservation form:', error);
                alert('‚ùå Error opening form: ' + error.message);
            }
            
            return false;
        }

        function hideReservationForm() {
            console.log('hideReservationForm called');
            
            try {
                const reservationForm = document.getElementById('reservation-form');
                const successDiv = document.getElementById('form-save-success');
                
                if (reservationForm) reservationForm.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
                
                editingReservationId = null;
                console.log('Reservation form hidden');
            } catch (error) {
                console.error('Error hiding form:', error);
            }
            
            return false;
        }

        function editReservation(reservationId) {
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            editingReservationId = reservationId;
            document.getElementById('form-title').textContent = '‚úèÔ∏è Edit Reservation';
            document.getElementById('set-current-btn').style.display = 'inline-block';
            
            // Fill form with reservation data
            document.getElementById('form-guest-name').value = reservation.guestName || '';
            document.getElementById('form-guest-count').value = reservation.guestCount || '';
            document.getElementById('form-checkin').value = reservation.checkin || '';
            document.getElementById('form-checkout').value = reservation.checkout || '';
            document.getElementById('form-confirmation').value = reservation.confirmation || '';
            document.getElementById('form-notes').value = reservation.notes || '';
            
            document.getElementById('reservation-form').style.display = 'block';
            document.getElementById('reservation-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveReservation() {
            console.log('saveReservation called');
            
            try {
                const guestName = document.getElementById('form-guest-name').value.trim();
                const guestCount = document.getElementById('form-guest-count').value;
                const checkin = document.getElementById('form-checkin').value;
                const checkout = document.getElementById('form-checkout').value;
                const confirmation = document.getElementById('form-confirmation').value.trim();
                const notes = document.getElementById('form-notes').value.trim();

                console.log('Form data:', { guestName, guestCount, checkin, checkout, confirmation, notes });

                if (!guestName || !guestCount || !checkin || !checkout) {
                    alert('‚ùå Please fill in all required fields (Guest Name, Guest Count, Check-in, Check-out)');
                    return false;
                }

                if (!validateFormDates()) {
                    return false;
                }

                const reservationData = {
                    guestName,
                    guestCount: parseInt(guestCount),
                    checkin,
                    checkout,
                    confirmation: confirmation || generateConfirmationCode(),
                    notes,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };

                console.log('Reservation data to save:', reservationData);

                if (editingReservationId) {
                    // Update existing reservation
                    console.log('Updating existing reservation:', editingReservationId);
                    const index = allReservations.findIndex(r => r.id === editingReservationId);
                    if (index !== -1) {
                        reservationData.id = editingReservationId;
                        allReservations[index] = reservationData;
                        
                        // Update current booking if it's the one being edited
                        if (currentBooking && currentBooking.id === editingReservationId) {
                            currentBooking = reservationData;
                        }
                        console.log('Reservation updated successfully');
                    }
                } else {
                    // Add new reservation
                    console.log('Adding new reservation');
                    reservationData.id = Date.now().toString();
                    allReservations.push(reservationData);
                    console.log('New reservation added with ID:', reservationData.id);
                }

                saveData();
                updateDisplay();
                loadAllReservations();
                updateCurrentBookingDisplay();

                // Show success message
                const successDiv = document.getElementById('form-save-success');
                if (successDiv) {
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                        hideReservationForm();
                    }, 2000);
                }

                console.log('Reservation saved successfully');
                return false;
                
            } catch (error) {
                console.error('Error saving reservation:', error);
                alert('‚ùå Error saving reservation: ' + error.message);
                return false;
            }
        }

        function setReservationAsCurrent(reservationId) {
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            if (confirm(`Set "${reservation.guestName}" as the current active booking?`)) {
                currentBooking = reservation;
                saveData();
                updateDisplay();
                updateCurrentBookingDisplay();
                loadAllReservations();
                alert('‚úÖ Current booking updated successfully!');
            }
        }

        function setAsCurrentBooking() {
            if (!editingReservationId) return;
            
            const reservation = allReservations.find(r => r.id === editingReservationId);
            if (reservation && confirm(`Set "${reservation.guestName}" as the current active booking?`)) {
                currentBooking = reservation;
                saveData();
                updateDisplay();
                updateCurrentBookingDisplay();
                alert('‚úÖ Set as current booking successfully!');
            }
        }

        function deleteReservation(reservationId) {
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            if (confirm(`Are you sure you want to delete the reservation for "${reservation.guestName}"?`)) {
                // Remove from reservations list
                allReservations = allReservations.filter(r => r.id !== reservationId);
                
                // Clear current booking if it's the one being deleted
                if (currentBooking && currentBooking.id === reservationId) {
                    currentBooking = null;
                }
                
                saveData();
                updateDisplay();
                loadAllReservations();
                updateCurrentBookingDisplay();
                alert('‚úÖ Reservation deleted successfully!');
            }
        }

        function editCurrentBooking() {
            if (!currentBooking) return;
            editReservation(currentBooking.id);
        }

        function showAllReservations() {
            // Just scroll to the reservations list
            document.getElementById('reservations-list').scrollIntoView({ behavior: 'smooth' });
        }

        function validateFormDates() {
            const checkin = document.getElementById('form-checkin').value;
            const checkout = document.getElementById('form-checkout').value;
            const errorDiv = document.getElementById('form-date-error');

            if (checkin && checkout) {
                const checkinDate = new Date(checkin);
                const checkoutDate = new Date(checkout);

                if (checkoutDate <= checkinDate) {
                    errorDiv.style.display = 'block';
                    return false;
                }
            }

            errorDiv.style.display = 'none';
            return true;
        }

        function quickCheckOut() {
            console.log('quickCheckOut called');
            
            if (!currentBooking) {
                alert('‚ùå No current booking to check out');
                return false;
            }
            
            try {
                // Move to history
                currentBooking.status = 'completed';
                currentBooking.actualCheckout = new Date().toISOString();
                addToHistory(currentBooking);
                
                // Clear current booking
                currentBooking = null;
                saveData();
                updateDisplay();
                
                alert('‚úÖ Guest checked out successfully! Booking moved to history.');
                loadPropertyStatus();
                console.log('Check-out completed');
            } catch (error) {
                console.error('Error during check-out:', error);
                alert('‚ùå Error during check-out: ' + error.message);
            }
            
            return false;
        }

        function clearCurrentBooking() {
            console.log('clearCurrentBooking called');
            
            if (confirm('Are you sure you want to clear the current booking?')) {
                try {
                    if (currentBooking) {
                        addToHistory({...currentBooking, status: 'cancelled'});
                    }
                    currentBooking = null;
                    saveData();
                    updateDisplay();
                    
                    // Clear admin form
                    const formFields = ['admin-guest-name', 'admin-guest-count', 'admin-checkin', 'admin-checkout', 'admin-confirmation', 'admin-notes'];
                    formFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) field.value = '';
                    });
                    
                    alert('‚úÖ Current booking cleared successfully!');
                    console.log('Booking cleared successfully');
                } catch (error) {
                    console.error('Error clearing booking:', error);
                    alert('‚ùå Error clearing booking: ' + error.message);
                }
            }
            
            return false;
        }

        function generateDoorCode() {
            console.log('generateDoorCode called');
            
            try {
                const newCode = Math.floor(1000 + Math.random() * 9000).toString();
                const doorCodeField = document.getElementById('admin-door-code');
                
                if (doorCodeField) {
                    doorCodeField.value = newCode;
                    alert(`üîë New door code generated: ${newCode}`);
                    console.log('Door code generated:', newCode);
                } else {
                    console.error('Door code field not found');
                    alert('‚ùå Error: Door code field not found');
                }
            } catch (error) {
                console.error('Error generating door code:', error);
                alert('‚ùå Error generating door code: ' + error.message);
            }
            
            return false;
        }

        function loadSampleReservation() {
            console.log('loadSampleReservation called');
            
            try {
                // Create a sample reservation and add it to the list (don't overwrite current)
                const sampleReservation = {
                    id: Date.now().toString(),
                    guestName: 'John & Sarah Smith',
                    guestCount: 4,
                    checkin: '2025-07-18',
                    checkout: '2025-07-21',
                    confirmation: 'ABC123',
                    notes: 'Anniversary celebration',
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };
                
                // Add to reservations list without affecting current booking
                allReservations.push(sampleReservation);
                saveData();
                loadAllReservations();
                
                alert('üìÑ Sample reservation added to your list! It does NOT overwrite your current booking.');
                console.log('Sample reservation added successfully');
            } catch (error) {
                console.error('Error loading sample reservation:', error);
                alert('‚ùå Error adding sample reservation: ' + error.message);
            }
            
            return false;
        }

        // History management
        function addToHistory(booking) {
            try {
                let history = JSON.parse(localStorage.getItem('bookingHistory') || '[]');
                history.unshift({...booking, archivedAt: new Date().toISOString()});
                
                // Keep only last 50 bookings
                if (history.length > 50) {
                    history = history.slice(0, 50);
                }
                
                localStorage.setItem('bookingHistory', JSON.stringify(history));
            } catch (error) {
                console.error('Error saving to history:', error);
            }
        }

        function loadBookingHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('bookingHistory') || '[]');
                const container = document.getElementById('booking-history');
                
                if (history.length === 0) {
                    container.innerHTML = '<p>No booking history found.</p>';
                    return;
                }

                container.innerHTML = history.map(booking => `
                    <div class="booking-item ${booking.status === 'active' ? 'current-booking' : ''}">
                        <h4>${booking.guestName}</h4>
                        <p><strong>Dates:</strong> ${booking.checkin} to ${booking.checkout}</p>
                        <p><strong>Guests:</strong> ${booking.guestCount} | <strong>Status:</strong> ${booking.status}</p>
                        ${booking.confirmation ? `<p><strong>Confirmation:</strong> ${booking.confirmation}</p>` : ''}
                        ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
                        <p class="small-text">Archived: ${new Date(booking.archivedAt).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('booking-history').innerHTML = '<p>Error loading booking history.</p>';
            }
        }

        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all booking history? This cannot be undone.')) {
                localStorage.removeItem('bookingHistory');
                loadBookingHistory();
                alert('‚úÖ All booking history cleared successfully!');
            }
        }

        // Property status
        function loadPropertyStatus() {
            const occupancyStatus = document.getElementById('occupancy-status');
            const occupancyDetails = document.getElementById('occupancy-details');
            const accessStatus = document.getElementById('access-status');
            const currentDoorCode = document.getElementById('current-door-code');

            if (currentBooking) {
                if (currentBooking.status === 'checked-in') {
                    occupancyStatus.textContent = 'Occupied';
                    occupancyDetails.textContent = `${currentBooking.guestName} (${currentBooking.guestCount} guests)`;
                } else {
                    occupancyStatus.textContent = 'Reserved';
                    occupancyDetails.textContent = `Arriving ${currentBooking.checkin}`;
                }
                accessStatus.textContent = 'Active';
            } else {
                occupancyStatus.textContent = 'Available';
                occupancyDetails.textContent = 'No current guests';
                accessStatus.textContent = 'Secured';
            }

            if (currentDoorCode) {
                currentDoorCode.textContent = propertySettings.doorCode;
            }
        }

        // Maintenance functions (stubs)
        function saveMaintenanceInfo() {
            alert('‚úÖ Maintenance information saved successfully!');
        }

        function saveEmergencyContacts() {
            alert('‚úÖ Emergency contacts saved successfully!');
        }

        // CSV Import Functions
        function processCsvFile() {
            console.log('processCsvFile called');
            
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            
            console.log('File selected:', file);
            
            if (!file) {
                alert('‚ùå Please select a CSV file first');
                return false;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('‚ùå Please select a valid CSV file');
                return false;
            }

            // Show progress
            const progressDiv = document.getElementById('import-progress');
            const resultsDiv = document.getElementById('import-results');
            
            if (progressDiv) progressDiv.style.display = 'block';
            if (resultsDiv) resultsDiv.style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('File read successfully');
                    const csvText = e.target.result;
                    console.log('CSV content:', csvText.substring(0, 200) + '...');
                    
                    const results = parseCsvAndImport(csvText);
                    showImportResults(results);
                } catch (error) {
                    console.error('Error processing CSV:', error);
                    alert('‚ùå Error processing CSV file: ' + error.message);
                } finally {
                    if (progressDiv) progressDiv.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                console.error('Error reading file');
                alert('‚ùå Error reading file');
                if (progressDiv) progressDiv.style.display = 'none';
            };
            
            reader.readAsText(file);
            return false;
        }

        function parseCsvAndImport(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header row and one data row');
            }

            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
            const results = {
                total: 0,
                imported: 0,
                skipped: 0,
                errors: [],
                bookings: []
            };

            // Find column indices
            const columnMap = {
                guestName: findColumnIndex(headers, ['guest name', 'guest', 'name', 'guest_name']),
                checkin: findColumnIndex(headers, ['check-in', 'checkin', 'check_in', 'arrival', 'start']),
                checkout: findColumnIndex(headers, ['check-out', 'checkout', 'check_out', 'departure', 'end']),
                guests: findColumnIndex(headers, ['guests', 'guest count', 'guest_count', 'number of guests']),
                confirmation: findColumnIndex(headers, ['confirmation', 'confirmation code', 'confirmation_code', 'booking id']),
                phone: findColumnIndex(headers, ['phone', 'phone number', 'mobile']),
                email: findColumnIndex(headers, ['email', 'email address']),
                notes: findColumnIndex(headers, ['notes', 'special requests', 'comments'])
            };

            // Process each data row
            for (let i = 1; i < lines.length; i++) {
                results.total++;
                
                try {
                    const row = parseCsvRow(lines[i]);
                    if (row.length === 0) continue;

                    const booking = {
                        guestName: getColumnValue(row, columnMap.guestName),
                        checkin: formatDate(getColumnValue(row, columnMap.checkin)),
                        checkout: formatDate(getColumnValue(row, columnMap.checkout)),
                        guestCount: parseInt(getColumnValue(row, columnMap.guests)) || 2,
                        confirmation: getColumnValue(row, columnMap.confirmation) || generateConfirmationCode(),
                        phone: getColumnValue(row, columnMap.phone),
                        email: getColumnValue(row, columnMap.email),
                        notes: getColumnValue(row, columnMap.notes),
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        source: 'csv-import'
                    };

                    // Validate required fields
                    if (!booking.guestName || !booking.checkin || !booking.checkout) {
                        results.errors.push(`Row ${i + 1}: Missing required fields (Guest Name, Check-in, Check-out)`);
                        continue;
                    }

                    // Validate dates
                    if (new Date(booking.checkout) <= new Date(booking.checkin)) {
                        results.errors.push(`Row ${i + 1}: Check-out date must be after check-in date`);
                        continue;
                    }

                    // Check for conflicts if not overwriting
                    const overwriteExisting = document.getElementById('overwrite-existing').checked;
                    if (!overwriteExisting && hasDateConflict(booking)) {
                        results.skipped++;
                        results.errors.push(`Row ${i + 1}: Date conflict with existing booking (${booking.guestName})`);
                        continue;
                    }

                    results.bookings.push(booking);
                    results.imported++;

                } catch (error) {
                    results.errors.push(`Row ${i + 1}: ${error.message}`);
                }
            }

            // Import successful bookings
            if (results.imported > 0) {
                // If importing multiple bookings, save them to history and set the most recent as current
                const sortedBookings = results.bookings.sort((a, b) => new Date(a.checkin) - new Date(b.checkin));
                
                // Add all to history
                sortedBookings.forEach(booking => addToHistory(booking));
                
                // Set the next upcoming booking as current
                const now = new Date();
                const upcomingBooking = sortedBookings.find(b => new Date(b.checkin) >= now);
                
                if (upcomingBooking) {
                    currentBooking = upcomingBooking;
                } else if (sortedBookings.length > 0) {
                    // If no upcoming bookings, use the most recent
                    currentBooking = sortedBookings[sortedBookings.length - 1];
                }

                saveData();
                updateDisplay();
            }

            return results;
        }

        function findColumnIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const index = headers.findIndex(h => h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function parseCsvRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function getColumnValue(row, columnIndex) {
            if (columnIndex === -1 || columnIndex >= row.length) return '';
            return row[columnIndex].replace(/"/g, '').trim();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            // Try different date formats
            const formats = [
                /^\d{4}-\d{2}-\d{2}$/, // YYYY-MM-DD
                /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY
                /^\d{2}-\d{2}-\d{4}$/, // MM-DD-YYYY
            ];
            
            for (const format of formats) {
                if (format.test(dateStr)) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0]; // Return YYYY-MM-DD
                    }
                }
            }
            
            // Try parsing as-is
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            throw new Error(`Invalid date format: ${dateStr}`);
        }

        function generateConfirmationCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function hasDateConflict(newBooking) {
            const newCheckin = new Date(newBooking.checkin);
            const newCheckout = new Date(newBooking.checkout);
            
            // Check against current booking
            if (currentBooking) {
                const currentCheckin = new Date(currentBooking.checkin);
                const currentCheckout = new Date(currentBooking.checkout);
                
                if ((newCheckin < currentCheckout && newCheckout > currentCheckin)) {
                    return true;
                }
            }
            
            // Could also check against history for more thorough conflict detection
            return false;
        }

        function showImportResults(results) {
            const resultsDiv = document.getElementById('import-results');
            resultsDiv.style.display = 'block';
            
            let html = `
                <div class="alert ${results.imported > 0 ? 'alert-success' : 'alert-error'}">
                    <h4>üìä Import Results</h4>
                    <p><strong>Total rows processed:</strong> ${results.total}</p>
                    <p><strong>Successfully imported:</strong> ${results.imported}</p>
                    <p><strong>Skipped:</strong> ${results.skipped}</p>
                    <p><strong>Errors:</strong> ${results.errors.length}</p>
                </div>
            `;
            
            if (results.errors.length > 0) {
                html += `
                    <div class="alert alert-error">
                        <h4>‚ùå Errors Found:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${results.errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (results.imported > 0) {
                html += `
                    <div class="alert alert-success">
                        <h4>‚úÖ Successfully Imported Bookings:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${results.bookings.map(booking => 
                                `<li><strong>${booking.guestName}</strong> - ${booking.checkin} to ${booking.checkout} (${booking.guestCount} guests)</li>`
                            ).join('')}
                        </ul>
                        <p><strong>Current booking updated:</strong> ${currentBooking ? currentBooking.guestName : 'None'}</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            
            // Clear the file input
            document.getElementById('csv-file-input').value = '';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadSampleCsv() {
            console.log('downloadSampleCsv called');
            
            try {
                const sampleCsv = `Guest Name,Check-in,Check-out,Guests,Confirmation,Phone,Email,Notes
"John & Sarah Smith","2025-07-18","2025-07-21",4,"ABC123","555-0123","john@email.com","Anniversary celebration"
"Mike Johnson","2025-08-01","2025-08-05",2,"DEF456","555-0124","mike@email.com","Business trip"
"The Williams Family","2025-08-15","2025-08-20",6,"GHI789","555-0125","williams@email.com","Family vacation"`;

                const blob = new Blob([sampleCsv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'cape_coral_reservations_sample.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('üìÑ Sample CSV downloaded! Use this as a template for your reservations.');
            } catch (error) {
                console.error('Error downloading sample:', error);
                alert('‚ùå Error downloading sample file');
            }
            
            return false;
        }

        function loadImportSettings() {
            // Load default settings
            document.getElementById('default-wifi').value = propertySettings.wifiName;
        }

        // Music functions (stubs)
        function connectSpotify() {
            alert('üéµ This would connect to Spotify in a real implementation');
        }

        function showJukeInstructions() {
            alert('üì± This would show Juke Audio app instructions');
        }

        function selectZone(zone) {
            const zoneNames = {
                'living': 'Living Room',
                'pool': 'Pool Area', 
                'kitchen': 'Kitchen',
                'all': 'Whole House'
            };
            
            document.getElementById('zone-selected').style.display = 'block';
            document.getElementById('selected-zone').textContent = zoneNames[zone];
        }

        function openPlaylist(type) {
            const playlists = {
                'tropical': 'Tropical Vibes',
                'chill': 'Chill Lounge',
                'party': 'Party Mix',
                'dinner': 'Dinner Jazz'
            };
            
            alert(`üéµ This would open the ${playlists[type]} playlist`);
        }
    </script>
